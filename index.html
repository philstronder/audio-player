<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio player</title>
    <link rel="stylesheet" href="style.css">
    <script
  src="https://code.jquery.com/jquery-2.2.4.min.js"
  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
  crossorigin="anonymous"></script> 
</head>
<body>
    <header>
        <div class="top-left-corner">
            <div class="top-left-corner-top"></div>
            <div class="top-left-corner-left"></div>
        </div>
        <div class="top-right-corner">
            <div class="top-right-corner-top"></div>
            <div class="top-right-corner-right"></div>
        </div>
    </header>
    
    <main>
        <section>
            <div class='title-line-1'>MUSICIAN</div>
            <div class='title-line-2'>AUDIO PLAYER</div>
        </section>
        <!-- <video controls id="videoPlayer"> -->
        <!-- <source src="" type="video/mp4"/> -->
        <!-- </video> -->
        <section>
            <div class="song-title">
                Dream Theater - Pull Me Under
            </div>
            <div class="slider-container">
                <div class="slider">
                    <div class="slider-current"></div>
                    <audio  id="audioPlayer"></audio>
                </div>
            </div>
            <div class="buttons-container">
                <div class="load-button" onclick="getFile()">
                    LOAD FILE
                    <input type="file" name="" id="fileUpload"/>
                </div>
                <!-- <input type="text" onchange="setDetune()" id="detune" value="-1"/> -->
                <button id="beginRange" class='control-button' onclick="setBeginRange()">A</<button type="submit"></button>
                <button id="endRange" class='control-button' onclick="setEndRange()">B</<button type="submit"></button>
                <button id="play" class='control-button' onclick="playAudio()">                                    
                    <svg width="28px" height="33px" viewBox="0 0 28 33" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g id="Audio-Player" transform="translate(-631.000000, -614.000000)" fill="#1F1D1D">
                                <g id="Play-Button" transform="translate(600.000000, 600.000000)">
                                    <polygon id="Path" points="31 14 31 47 59 30.5"></polygon>
                                </g>
                            </g>
                        </g>
                    </svg>  
                </<button type="submit"></button>
                <button id="pause" class='control-button' onclick="pauseAudio()">

                    <svg width="22px" height="33px" viewBox="0 0 22 33" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" stroke-linecap="square">
                            <g id="Audio-Player" transform="translate(-770.000000, -614.000000)" stroke="#000000" stroke-width="6">
                                <g id="Pause-Button" transform="translate(741.000000, 600.000000)">
                                    <path d="M32.5,17.4354839 L32.5,44" id="Line-4"></path>
                                    <path d="M47.5,17.4354839 L47.5,44" id="Line-4-Copy"></path>
                                </g>
                            </g>
                        </g>
                    </svg>                    
                </<button type="submit"></button>
            </div>
        </section>
        
        <section class="container">
            <div class="speed-controls">
                <div class="speed">
                    Speed
                    <input class="speed-value" type="text" onchange="setRate()" id="rate" value="1.0"/>
                </div>
                
                <div class="speed-options">
                    <!-- <div class="break"></div> -->
                    <div class="option selected">1.0</div>
                    <div class="option">1.1</div>
                    <div class="option">1.2</div>
                    <div class="option">1.3</div>

                    <div class="option">0.6</div>
                    <div class="option">0.7</div>
                    <!-- </div
                
                <div class="speed-options"> -->
                    <!-- <div class="break"></div> -->
                    <div class="option">0.8</div>
                    <div class="option">0.9</div>
                    <div class="option">0.2</div>
                    <div class="option">0.3</div>
                    <div class="option">0.4</div>
                    <div class="option">0.5</div>
                </div>
            </div>
        </section>

    </main>
            
    <footer>
        <div class="bottom-left-corner">
        </div>
        <div class="bottom-right-corner">
        </div>
    </footer>
    <script>
        var audio;
        document.getElementById('fileUpload').onchange = function() {
            document.getElementById('audioPlayer').src = URL.createObjectURL(document.getElementById('fileUpload').files[0])
            audio = document.getElementById('audioPlayer')
            setRate()
            setDetune()
        }
        
        var beginRange;
        var endRange;
        var loopDuration;
        var idLoop;
        var paused = false;
        
        function getFile(){
            document.getElementById('fileUpload').click()
        }

        function setRate() {
            audio.playbackRate = document.getElementById('rate').value;
        }

        function setDetune() {
            // audio.detune.value = document.getElementById('detune').value;

            const audioCtx = new AudioContext();

            const channelCount = 2;
            const frameCount = audioCtx.sampleRate * 2.0; // 2 seconds

            const myArrayBuffer = audioCtx.createBuffer(channelCount, frameCount, audioCtx.sampleRate);

            for (let channel = 0; channel < channelCount; channel++) {
                const nowBuffering = myArrayBuffer.getChannelData(channel);
                for (let i = 0; i < frameCount; i++) {
                    nowBuffering[i] = Math.random() * 2 - 1;
                }
            }

            const source = audioCtx.createBufferSource();
            source.buffer = myArrayBuffer;
            source.connect(audioCtx.destination);
            source.detune.value = 200; // value in cents
            source.start();
        }

        function setBeginRange() {
            beginRange = !beginRange ? audio.currentTime : false;
            
            if(idLoop) endLoop();

            idLoop = beginLoop();

            if(beginRange)
                document.getElementById('beginRange').style = "border: 2px solid red;";
            else
                document.getElementById('beginRange').style = "";
        }

        function setEndRange() {
            if(audio.currentTime > beginRange || !beginRange) {
                //endRange will be undefined on first click
                //if was already clicked and deactivated, will be equal to audio.duration, meaning that the loop will end only on the file's end.
                if(endRange == undefined || endRange == audio.duration) {
                    endRange = audio.currentTime;
                } else {
                    endRange = false;
                }

                if(endRange)
                    document.getElementById('endRange').style = "border: 2px solid red;";
                else
                    document.getElementById('endRange').style = "";

                if(beginRange && endRange) {
                    idLoop = beginLoop();
                } else {
                    //sets endRange to the audio's end
                    endRange = audio.duration;
                }    
            }
        }

        function beginLoop() {
            idLoop = setInterval(function(){
                if(audio.currentTime >= endRange) {
                    audio.currentTime = beginRange;
                    audio.play()
                }
            }, 500)

            return idLoop;
        }

        function endLoop(beginValue, endValue) {
            clearInterval(idLoop);
            audio.currentTime = audio.currentTime
            audio.play()
        }

        function playAudio() {
            if(!paused) {
                if(beginRange) {
                    audio.currentTime = beginRange;
                }  
            }
            
            audio.play();
        }

        function pauseAudio() {
            audio.currentTime = audio.currentTime
            audio.pause();
            paused = true;
        }
        </script>
</body>
</html>